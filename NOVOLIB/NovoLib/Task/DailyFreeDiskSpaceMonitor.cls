Include Ensemble

Class NovoLib.Task.DailyFreeDiskSpaceMonitor Extends %SYS.Task.Definition
{

Property SMTPServer As %String [ InitialExpression = "SMTP.gmail.com", Required ];

Property EmailDistributionList As %String(MAXLEN = 200) [ Required ];

/// How many days of messages should not be purged
Property NumberToQuery As %Integer(MINVAL = 0) [ InitialExpression = 7, Required ];

/// The type of thing to purge
Property PeriodToQuery As %String(DISPLAYLIST = ",Day(s),Week(s),Month(s)", VALUELIST = ",DAY,WEEK,MONTH") [ InitialExpression = "DAY", Required ];

Parameter TaskName = "NovoLib.Task.DailyFreeDiskSpaceMonitor";

/// This task will generate an email containing Disk Space Information.
/// 
/// The email will contain the following detail:
///    DiskSpace
///    
///    
Method OnTask() As %Status
{
	s tStatus = $$$OK
	s sSQL = ""
	
	s tPeriodToQuery = ..PeriodToQuery
	s tNumberToQuery = ..NumberToQuery
		
	s theEmailBody="<HTML>"
	s theEmailBody=theEmailBody_"<h3>[DO NOT REPLY TO THIS EMAIL]</h3>" 
	
	s theEmailBody=theEmailBody_"<table><tr><td style='font-weight:bold'>System:</td><td>"_$SYSTEM_"</td></tr>"
	s theEmailBody=theEmailBody_"<tr><td style='font-weight:bold'>Namespace:</td><td>"_$NAMESPACE_"</td></tr></table>"

	s theEmailBody=theEmailBody_"<br><table border='1'><tr><td/><td style='font-weight:bold'>Count</td></tr>"
	
	
	s theEmailBody=theEmailBody_"</table><br>"
	
	s theEmailBody=theEmailBody_"<br><h4>This email was generated by the “Daily Free Space” task on the "_$NAMESPACE_"</h4>"
	s theEmailBody=theEmailBody_"<h3>[DO NOT REPLY TO THIS EMAIL]</h3>"
	s theEmailBody=theEmailBody_"</HTML>"
	do ..SendMail(theEmailBody)

	$$$LOGINFO("Free Diskspace Task has completed successfully.")
	
 	Quit tStatus
}

Method SendMail(emailBody As %String) As %Status
{
	
    // Create an SMTP object and connect to a server
    Set Mailer = ##class(%Net.SMTP).%New()
    Set Mailer.smtpserver = ..SMTPServer

	Set msg = ##class(%Net.MailMessage).%New()
    set msg.From = "no-reply@gmail.com"

	s distList = $listfromstring(..EmailDistributionList)
	if ('$listvalid(distList)) {
		quit $$$ERROR($$$GeneralError, "EmailDistributionList is not a valid comma delimited list")
	}
	for i=1:1:$listlength(distList) {
		do msg.To.Insert($list(distList,i))
	}

    Set msg.Subject="Free Disk Space "_$zd($h, 12)_", "_$zd($h, 3)
    Set msg.IsBinary=0
    Set msg.IsHTML=1
    Do msg.TextData.Write(emailBody)
    // Send the message and close objects
    Do Mailer.Send(msg)

    Quit $$$OK
}

}
